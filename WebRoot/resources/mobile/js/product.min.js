(function(a) {
    window.mxg_product = {
    		ltSpGoodsSpecId:null,
        init: function() {
            this.eventInit()
        },
        eventInit: function() {
            this.headerInit();
            this.lazyLoadInit();
            this.dealGoods();
            //规格选择
            this.goodsOption();
            //商品规格
            this.proSpecifition();
            this.specFunc();
            this.brandSelect();
        },
        brandSelect:function(){
        	
        },
        specParams:function(){
        	
        	var ltSpGoodsSpecId = 0;
        	//商品id
        	var goodsid = a("#goods_id").val();
        	var i = 1;
        	var s = "spec" + 1;
        	var v = "";
        	var data=[];
        	/*a(".color_options li").siblings().each(function(index){
        		var li = $("#color_options li:eq("+index+")");
        		if(li.hasClass("on")){
        			console.log(123);
        			var param_key = li.parent().prev().text();
        			var param_value = li.text();
        			v += param_key+":"+param_value+","
        			data.push(param_value);
        			
        			//console.log(param_value)
        		}        		
        	});*/
        	a(".spec").each(function(index){
        		var li = $(this);
        		if(li.hasClass("on")){
        			var param_key = li.parent().prev().text();
        			var param_value = li.text();
        			v += param_key+":"+param_value+","
        			data.push(param_value);
        		}        		
        	});
        	//console.log(data)
        	var data1=[];       	
        	
        	for(var j=0; j<Zepto.specJson.length;j++){
    			var dataT = [];
    			if(Zepto.specJson[j] != undefined){
    				dataT[0]=Zepto.specJson[j].spec1;
            		dataT[1]=Zepto.specJson[j].spec2;
            		dataT[2]=Zepto.specJson[j].spec3;
            		dataT[3]=Zepto.specJson[j].spec4;
            		dataT[4]=Zepto.specJson[j].spec5;
    			}   
    			//得到当前规格
    			
    			//console.log(data.toString().replace(",","").replace(/[ ]/g,"").replace(/[\r\n]/g,"")+"----"+dataT.toString().replace(",","").replace(/[ ]/g,"").replace(/[\r\n]/g,""));
    			if(dataT.toString().replace(",","").indexOf(data.toString().replace(",",""))>-1){
    				
    				
    				//得到規格    				
    				a(".price i").html(Zepto.specJson[j].price);
    				a("#main_price").html(Zepto.specJson[j].price);
    				if(Zepto.specJson[j].saleOnhandQty == 0){
    					a("#saleOnhandQty").html("库存 0 ");
    				}else{
    					a("#saleOnhandQty").html(Zepto.specJson[j].saleOnhandQty);
    				}
    				if(Zepto.specJson[j].imagePath != ""){
        				$("#suolue_img").attr('src',Zepto.specJson[j].imagePath);    					
    				}
    				ltSpGoodsSpecId = Zepto.specJson[j].id;    
    			//	alert(ltSpGoodsSpecId)
    				break;
    			}
        	}
        	
        	return ltSpGoodsSpecId;
        },
        specFunc:function(){
        	var o = this;
        	a(".color_options li").click(function(b){           		
        		if(a(this).siblings().hasClass("on")){
        			a(this).siblings().removeClass("on");
        		}
        		a(this).addClass("on");
        		
        		var i=0;
        		a(".color_options li").siblings().each(function(index){
        			var li = $("#color_options li:eq("+index+")");
        			if(li.hasClass("on")){
        				i++;
        			}
        		});
        		o.ltSpGoodsSpecId = o.specParams();
        	});
        	
        	
        },
        headerInit: function() {
        	//顶部隐藏菜单
            a(".header .menu").click(function(b) {
                a(this).hasClass("active") ? (a(this).removeClass("active"), a(".t-nav").removeClass("active")) : (a(this).addClass("active"), a(".t-nav").addClass("active"));
                b.preventDefault();
            })
        },
        dealGoods: function(){
        	var o = this;
        	//物品数量减1
            a(".minus").click(function(){            	
            	var goods_count = a.trim(a("#buy_num").val());
            	goods_count = (goods_count.length==0 || goods_count<=1) ? 1 : parseInt(goods_count)-1;
            	if(goods_count==1){
            		a(this).removeClass("on")
            	}
            	a("#buy_num").val(goods_count);
            });
            //物品数量加1
            a(".plus").click(function(){
            	var goods_count = a.trim(a("#buy_num").val());
            	goods_count = (goods_count.length==0 || goods_count<=0) ? 1 : parseInt(goods_count)+1;
            	if(!a(".minus").hasClass("on")){
            		a(".minus").addClass("on");
            	}
            	a("#buy_num").val(goods_count);
            });
            //物品数量失焦
            a("#buy_num").blur(function(){
            	var obj = $(this);
            	if(!(/^\+?[1-9][0-9]*$/.test(obj.val()))){//只能输入正整数
            		obj.val(1);
            	}
            });
            
            var kuchunVal =  $("#kuchunVal").text();
            var saleEndTime =  $("#saleEndTime").val();
            var nowDa = new Date() ;
           
            //加入购物车
            a(".btn_con .add").click(function(){ 

                if(nowDa > Date.parse(saleEndTime)){
                	showError("此商品已下架");
            		return ;
                }
            	if(kuchunVal == 0){
            		showError("无货");
            		return ;
            	}
            	var specSize = $("#useSpecSize").val();
            	if($("#isUseSpec").val() == 1){
            		
            		if( o.ltSpGoodsSpecId== null){
            			a(".mask").show();
                		a("#option_detail").css("visibility","visible");
            			return;
            		}else{
            			var sum = 0;
                    	
                    	a(".color_options li").each(function(){
                    		if($(this).hasClass("on"))sum++;
                    	});
                    	if(!$(".color_options").length == sum){
                    		showError("请选择规格");
                    		return ;
                    	}
                    	
            		}           
            	}else{
            		 o.ltSpGoodsSpecId = Zepto.specJson[0].id;
            	}
            	o.loginValidate(1); 
            	
            });
            //购买
            a(".btn_con .buy").click(function(){
            	if(nowDa > Date.parse(saleEndTime)){
                	showError("此商品已下架");
            		return ;
                }
            	if(kuchunVal == 0){
            		showError("无货");
            		return ;
            	}
            	var specSize = $("#useSpecSize").val();
            	if($("#isUseSpec").val() == 1){
            		if(o.ltSpGoodsSpecId == null){
            			a(".mask").show();
                		a("#option_detail").css("visibility","visible");
            			return;
            		}else{
            			var sum = 0;
                    	$(".option_detail ul li").each(function(){
                    		if($(this).hasClass("on"))sum++;
                    	});
                    	
                    	if(specSize != sum){
                    		showError("请选择规格");
                    		return ;
                    	} 
            		}           
            	}else{
            		 o.ltSpGoodsSpecId = Zepto.specJson[0].id;
            	}
            	o.loginValidate(2); 
            	$(this).unbind('click');
            });
            //收藏物品
            var isTrue = false;
            a(".fav").click(function(){
            	//需要做用户是否登陆判断
            	$.ajax({
    				url: base +"/mobile/login/login.action",
    				type: "POST",
    				data:{
    					"result":"json"
    				},
    				dataType: "json",
    				cache: false,
    				success: function(message) {
    					if(!message.success){
    						window.location = base+"/mobile/login/login.action?currentUrl=" + window.location.href;
    					}else{
    						isTrue = true;
    					}
    				}
    			});
            	if(isTrue){
            		if(!a(this).hasClass("on")){
                		$.ajax({
                            type: "GET",
                            url: base+"/mobile/member/favorite!save.action",
                            dataType: "json",
                            data:{
                            	"entity.objectId":a("#goods_id").val(),
                            	"entity.keepKind":0
                            },
                            success: function(c) {
                            	if(c.success){}else{
                            		showError(c.msg);
                            	}
                            },
                            error: function(a, b, d) {
                               
                            }
                        });
                    	a(this).addClass("on");
                	}else{
                		$.ajax({
                            type: "GET",
                            url: base+"/mobile/member/favorite!delete.action",
                            dataType: "json",
                            data:{
                            	"entity.objectId":a("#goods_id").val(),
                            	"entity.keepKind":0
                            },
                            success: function(c) {
                            	if(c.success){}else{
                            		showError(c.msg);
                            	}
                            },
                            error: function(a, b, d) {
                               
                            }
                        });
                    	a(this).removeClass("on");
                	}
            	}
            	
            });
        },
        loginValidate:function(i){
        	var o = this;
        	$.ajax({
				url: base +"/mobile/login/login.action",
				type: "POST",
				data:{
					"result":"json"
				},
				dataType: "json",
				cache: false,
				success: function(message) {
					if(message.success == true || message.success == 'true'){
						o.saveData(i);												
					}else{
						window.location = base+"/mobile/login/login.action?currentUrl=" + window.location.href;
					}
				}
			});
        	/*if(memberId == "null"){
        		window.location = base+"/mobile/login/login.action?currentUrl=" + window.location.href;
        	}else{
        		o.saveData(i);
        	}*/
        },
        saveData: function(i){
        	var o = this;
        	var ltSpGoodsSpecId = o.ltSpGoodsSpecId;
        	//alert(ltSpGoodsSpecId);
        	//商品id
        	var goodsid = a("#goods_id").val();
        	
        	var b = a("#buy_num"),c=a(".cart i");
        	//商品数量
        	var n = c.html()=="" ? b.val() :  parseInt(c.html()) + parseInt(b.val());
        	
        	
        	//将物品信息写入库表
        	var goodnum = a("#buy_num").val();
        	$.ajax({
                type: "GET",
                url: base+"/mobile/order/cart!save.action",
                data:{
                	"entity.ltSpGoodsId":goodsid,
                	"entity.qty":goodnum,
                	"result":'json',
                	"entity.ltSpGoodsSpecId":ltSpGoodsSpecId
                },
                dataType:'json',
                success: function(c) {
                	if(c.success){
                		if(i ==2){
                			window.location.href=base+"/mobile/order/cart!list.action"
                		}                		
                	}else{
                		showError(c.msg);
                	}
                },
                error: function(a, b, d) {
                	
                }
            });
        	c.css("display","inline").html(n);
        },
        goodsOption: function(){
        	a(".option #pro_option").click(function(){
        		a(".mask").show();
        		a("#option_detail").css("visibility","visible");
        	});
        	a(".mask").click(function(){//点击遮罩的时候，遮罩消失
        		$(this).hide();
        		a("#option_detail").css("visibility","hidden");
        	});
        	
        	$(".close").click(function(){//规格遮罩框
        		a("#option_detail").css("visibility","hidden");
        		a(".mask").hide();
        	});
        },
        proSpecifition: function(){
        	a("#pro_specification").click(function() {
        		a(this).find("div.arrow_d").toggleClass("up");
        		a("#pro_specification_detail").toggle();
        		//alert((".select_box").html());
            });
        },
        images: function(a) {
            var c = new Image,
            e = a.attr("imgsrc");
            c.onload = function() { ! 0 == c.complete && (a.attr("src", e), a.removeClass("lazy"), a.removeAttr("imgsrc"))};
            c.src = e
        },
        slideInit: function(a) {
            var c = this;
            a.on("scrollStart",
            function() {
                window.clearInterval(a.timer);
                a.timer = setInterval(function() {
                    a.directionX = 1;
                    c.slidePic(a)
                },
                5E3)
            });
            a.on("scrollEnd",
            function() {
                c.slidePic(this)
            });
            c.slideRun(a);
        },
        slidePic: function(b) {
            0 != b.directionX && (b.pageNum += b.directionX, b.pageNum >= b.pageSize ? b.pageNum = 0 : 0 > b.pageNum && (b.pageNum = b.pageSize - 1), b.scrollToElement(a(b.scroller).find("li").eq(b.pageNum)[0], 300), a(b.wrapper).find(".on").removeClass("on"), a(b.wrapper).find(".dot li").eq(b.pageNum).addClass("on"), b.directionX = 0);
        },
        slideRun: function(a) {
            var c = this;
            a.timer = setInterval(function() {
                a.directionX = 1;
                c.slidePic(a)
            },
            5E3)
        },
        productSliderInit: function() {
            this.topSlider = a.os.ios ? new IScroll("#slider", {
                useTransition: !1,
                scrollX: !0,
                scrollY: !1,
                snap: !1,
                momentum: !1,
                click: !1,
                eventPassthrough: !0,
                preventDefault: !0
            }) : new IScroll("#slider", {
                scrollX: !0,
                scrollY: !1,
                snap: !1,
                momentum: !1,
                click: !1,
                eventPassthrough: !0,
                preventDefault: !0
            });
            this.topSlider.pageNum = 0;
            this.topSlider.pageSize = a(".top-slider li").length;
            this.slideInit(this.topSlider);
            if(this.topSlider.pageSize >1){
            	this.sliderPullToJump(a(".top-slider li").last());
            }            
            
            a("#slider li").on("click",
            function() {
                a("#bigpic").toggleClass("bigpic");
                a("#cell").toggleClass("cell")
            })
        },
        sliderPullToJump: function(b) {
        	
            var c = this;
            b.on("touchstart",
            function(b) { ! a("#bigpic").hasClass("bigpic") && (c.pullStartX = b.touches[0].pageX) && (c.pullStartY = b.touches[0].pageY)
            });
            b.on("touchmove",
            function(b) { ! a("#bigpic").hasClass("bigpic") && b.touches[0].pageX < c.pullStartX && Math.abs(b.touches[0].pageX - c.pullStartX) > Math.abs(b.touches[0].pageY - c.pullStartY) && !a("#slider").hasClass("tip") && a("#slider").addClass("tip") && window.clearInterval(c.topSlider.timer)
            });
            b.on("touchend",
            function(b) {
                setTimeout(function() {
                    //a("#slider").hasClass("tip") && (a("#slider").removeClass("tip"), location.href = a("#detail_link").attr("href"))
                },
                0)
            })
        },
        lazyLoadInit: function() {
            var b = this;
            this.alsoBuyLazyload = this.guessLazyload = !1;
            a(".lazy").each(function() {
                b.images(a(this))
            });
            window.onscroll = function() {
                a(".lazy").each(function() {
                    b.images(a(this))
                });
            }
        }
    };
    a(document).ready(function() {
        FastClick.attach(document.body);
        mxg_product.init();
        window.onload = function() {
            mxg_product.productSliderInit();
        }
    })
})(Zepto);