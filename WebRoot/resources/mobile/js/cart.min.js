(function(a) {
    var f = {
    	ids:null,
    	goodsId :"",
        init: function() {
        	
            this.isScroll = 1;
            this.initScroller();
            
            //默认选中商品
            this.bindCheckboxClick();
            //默认选中全选
            this.bindCheckAll();
            //默认选中商品店铺
            this.autoCheckbox();
            //商品总价格
            this.getTotalPrice();
            //商品结算
            this.bindCheckout();
            //商品数量加减输入框
            //a(".prod_num").on("focus", this.initProdNum);
            a(".prod_num").on("change",this.numChange);
            //删除商品
            a(".cart_item").on("click", ".garbage", this.deleteItem);
            //显示商品规格显示框
			a(".attrs").on("click",this.showProNormInfo);
			//关闭商品规格显示框
			a(".c_close,.f_mask").on("click",this.closeBox);
            //遮罩
            a(".maskup").on("click", this.maskClick);
            //顶部下来菜单
            a(".header .menu").click(function(b) {
                a(this).hasClass("active") ? (a(this).removeClass("active"), a(".t-nav").removeClass("active")) : (a(this).addClass("active"), a(".t-nav").addClass("active"));
                b.preventDefault()
            })
            this.specFunc();
            
            var o = this;
            a(".c_btn").on("click",function(){
            	/*var ltSpGoodsSpecId = o.specParams();
            	alert(ltSpGoodsSpecId)
            	a(".f_mask").hide();*/
            });
            
            a(".c_checkbox").on("click",function(){   
            	var c = $(this).parent().parent().find(".shop_title").find("input"); 
            	var item = $(this).parent().parent().find(".cart_item").find("input"); 
            	
            	if(!a(this).prop("checked")){            		           		
            		c.prop("checked",!1);
            	}else{
            		var booleanFlag = true;
            		item.each(function(){            			
            			if(!a(this).prop("chekced")){
            				booleanFlag = false;
            			}
            		})
            		/*alert(booleanFlag)
            		if(booleanFlag){
            			c.prop("checked",!0);
            		}*/
            	}            	
            	o.getTotalPrice();
            });
            
            a(".prod_num").on("change",function(){
            	o.getTotalPrice();
            });
            
            a(".shop_title").find("input").on("change",function(){
            	 var c = a(this).prop("checked");
            	 var vo = $(this).parent().parent();
        		 vo.find(".c_checkbox").each(function(){        			 
        			 if(c){
                		 //全选组
        				 a(this).prop("checked", !0); 
                	 }else{
                		 //全不选
                		 a(this).prop("checked", !1);
                	 }
        			 o.getTotalPrice();
        		 });            	 
            });
        },
        numChange:function(o,n){
        	
        	var cartId = $(this).parent().parent().parent().attr("item_id");
        	var qty = $(this).val();
        	/*if(qty <= 0) {
        		alert(qty);
        		return;
        	}*/
        	$.ajax({
                type: "GET",
                url: "../order/cart!save.action",
                dataType: "json",
                data:{
                	"entity.id":cartId,
                	"entity.qty":qty,
                	"result":"json"
                },
                success: function(c) {
                	
                },
                error: function(a, b, d) {
                }
            });
        },
        specFunc:function(){
        	a("#color_options span").click(function(b){  
        		
        		if(a(this).siblings().hasClass("on")){
        			a(this).siblings().removeClass("on");
        		}
        		a(this).addClass("on");
        		
        		var i=0;
        		a("#color_options span").siblings().each(function(index){
        			var li = $("#color_options li:eq("+index+")");
        			if(li.hasClass("on")){
        				i++;
        			}
        		});
        		//alert(i);
        		//console.log($(".color_name").length)
        	});
        	
        	
        },
        specParams:function(){
        	
        	var ltSpGoodsSpecId = 0;
        	//商品id
        	var goodsid =this.goodsId;
        	var i = 1;
        	var s = "spec" + 1;
        	var v = "";
        	var data=[];
        	a("#color_options span").siblings().each(function(index){
        		var li = $("#color_options span:eq("+index+")");
        		if(li.hasClass("on")){
        			var param_key = li.parent().prev().text();
        			var param_value = li.text();
        			v += param_key+":"+param_value+","
        			data.push(param_value);
        		}        		
        	});
        	var data1=[];
        	var specJson = eval(Zepto.specJson);
        	//console.log(specJson)
        	for(var j=0; j<specJson.length;j++){
    			var dataT = [];
    			if(specJson[j] != undefined){
    				dataT[0]=specJson[j].spec1;
            		dataT[1]=specJson[j].spec2;
            		dataT[2]=specJson[j].spec3;
            		dataT[3]=specJson[j].spec4;
            		dataT[4]=specJson[j].spec5;
    			}   
    			//得到当前规格
    			//console.log(data.toString().replace(",","").replace(/[ ]/g,"").replace(/[\r\n]/g,"")+"-"+dataT.toString().replace(",","").replace(/[ ]/g,"").replace(/[\r\n]/g,""));
    			if(dataT.toString().replace(",","").indexOf(data.toString().replace(",",""))>-1){
    				//得到規格
    				
    				/*a(".price i").html(Zepto.specJson[j].price);
    				a("#main_price").html(Zepto.specJson[j].price);
    				if(Zepto.specJson[j].saleOnhandQty == 0){
    					a("#saleOnhandQty").html("缺貨");
    				}else{
    					a("#saleOnhandQty").html(Zepto.specJson[j].saleOnhandQty);
    				}*/
    				ltSpGoodsSpecId = specJson[j].id;
    			}
        	}
        	//得到规格id
        	//console.log(ltSpGoodsSpecId)
        	/*$.ajax({
                type: "GET",
                url: "../goods/spec!change.action",
                dataType: "json",
                data:{
                	"goodsid":goodsid,
                	"spec":v
                },
                success: function(c) {
                	
                	alert("選擇規格改變價格");
                },
                error: function(a, b, d) {
                   
                }
            });*/
        	
        	return ltSpGoodsSpecId;
        },
        initScroller: function() {
            function b() {
                if (/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent)) return ! 1;
                if (/Chrome/i.test(navigator.userAgent)) return /Android/i.test(navigator.userAgent);
                if (/Silk/i.test(navigator.userAgent)) return ! 1;
                if (/Android/i.test(navigator.userAgent)) {
                    var a = navigator.userAgent.substr(navigator.userAgent.indexOf("Android") + 8, 3);
                    return 44 > parseFloat(a[0] + a[3]) ? !1 : !0
                }
            }
            var c = a(".list_null").height(); - 1 < navigator.userAgent.indexOf("MQQB") && a(".jp_block").css({
                top: "50%"
            });
            setTimeout(function() {
                if (c) {
                    f.empty = !0;
                    a("html,body").css({
                        "-webkit-overflow-scrolling": "touch",
                        height: "auto"
                    });
                    var e = (190 * a(".advs").val() - 10) / 20;
                    a(".guessList").css({
                        width: e + "rem"
                    });
                    a(".viewport section:last-child").css({
                        "margin-bottom": "0px"
                    })
                } else e = window.innerHeight - a("footer").height() - a(".h_label").height(),
                f.empty = !1,
                a("#wrapper").height(e),
                a(".viewport").css({
                    overflow: "initial"
                }),
                f.scroller = new IScroll("#wrapper", {
                    click: b()
                }),
                window.isAndroidWebview = /Android/i.test(navigator.userAgent),
                window.inputMoved = !1,
                a(".header .menu").on("click",
                function() {
                    setTimeout(function() {
                        var b = window.innerHeight - a(".t-nav").height() - a("footer").height() - a(".h_label").height();
                        a("#wrapper").height(b);
                        f.scroller && f.scroller.refresh()
                    },
                    500)
                })
            },
            0)
        },
        bindCheckAll: function() {
        	var b = this;
            a("#cart_check_all").click(function() {
                a("input[type=checkbox]", a(".block")).prop("checked", a(this).prop("checked"));
                var c = "";
                a("div.cart_item", a(".content")).each(function(b, d) {
                    c += a(d).attr("item_id") + ","
                });
                a(this).prop("checked") ? b.checkItems(c.substr(0, c.length - 1), "", "") : b.unCheckItems(c.substr(0, c.length - 1), "", "")
            })
        },
        bindCheckboxClick: function() {
           
        	var amt = 0;
        	$(".cart_item").each(function(){
        		
        		var price = $(this).find(".cart_price").text();
        		var qty = $(this).find(".prod_num").val();
        		amt += Number(price) * parseInt(qty);  
        	});
        	$("#cart_price").text(getRound(amt));
        },
        checkShopCheckboxes: function(b) {
        	a("input[type=checkbox]",a(this).closest(".block")).prop("checked", a(this).prop("checked"));
        	f.getTotalPrice();
        },
        autoCheckbox: function() {
        	var b = !0;
            a(".shop_title", ".content").each(function(c, e) {
                var d = !0;
                a("input[type=checkbox]", a("div.cart_item", a(e).parent())).each(function(b, c) {
                    a(c).prop("checked") || (d = !1)
                });
                if (d) {
                    a("input[type=checkbox]", a(e)).prop("checked", !0);
                    var g = a(e).parent().prev();
                    "undefined" != typeof g.attr("class") && g.hasClass("promotion_title") && a("input[type=checkbox]", g).prop("checked", !0);
                    a("#cart_check_all").prop("checked", !0)
                } else a("input[type=checkbox]", a(e)).prop("checked", !1),
                g = a(e).parent().prev(),
                "undefined" != typeof g.attr("class") && g.hasClass("promotion_title") && a("input[type=checkbox]", g).prop("checked", !1);
                a("input[type=checkbox]", a(e)).prop("checked") || (b = !1)
            });
            b ? a("#cart_check_all").prop("checked", !0) : a("#cart_check_all").prop("checked", !1)
        },
        batchPromotionUpdate: function(b, c) {
            var e = 1,
            d = b.attr("batch_id");
            a("div.cart_item", b.next()).each(function(b, c) {
                e = a("span.quantity", a(c)).text()
            });
            c ? this.checkItems("", d + "-" + e) : this.unCheckItems("", d + "-" + e)
        },
        initPrdColorSize: function() {
            f.empty || (document.getElementsByTagName("body")[0].style.height = document.documentElement.clientHeight + "px");
            
        },
        checkItems: function(b, c, e) {
        	//选中商品
        	f.getTotalPrice();
        },
        unCheckItems: function(b, c, e) {
           //商品去掉选中
        	f.getTotalPrice();
        },
        getCartPriceAndQuantity: function(b) {
            //取数渲染购物车商品信息（价格数量等）
        	f.getTotalPrice();
        },
        deleteItem: function(b, c) {
            var e = {},
            d = "",
            g = this == f ? b: a(this),
            k = g.closest(".block").find("div.promotion_title");
            item = g.closest(".cart_item");
            "garbage" == g.attr("class") && g.addClass("on");
            k[0] && (d = k.attr("batch_id"));
            e.batch_ids = d ? d: "";
            e.item_ids = d ? "": item.attr("item_id");
            var h = g.closest(".block");
            a.dialogBox("\u786e\u5b9a\u8981\u5220\u9664\u8be5\u5546\u54c1\u5417\uff1f", "",
            function() {
                //删除处理
            	
            	this.ids = 100;
            	$.ajax({
                    type: "GET",
                    url: "../order/cart!delete.action",
                    dataType: "json",
                    data:{
                    	"ids":e.item_ids
                    },
                    success: function(c) {
                    	if(c.success){
                    		
                        	item.remove(); //删除购物车物品
                        	f.getTotalPrice();
                        	$("#cart_quantity").text(Number($("#cart_quantity").text()) - 1);
                    	}else{
                    		showError(c.msg);
                    	}
                    },
                    error: function(a, b, d) {
                    }
                });
                //重新调节高度
                f.refreshHeight();
            },
            function() {
                g.removeClass("on");
                c && c();
                a(".maskup").css({
                    display: "none"
                })
            })
        },
        showProNormInfo: function(){
        	var itemId = $(this).find(".spec_st").attr("cart_id");
        	var goodId = $(this).find(".goodsId").val();
        	
        	this.goodsId = goodId;
        	Zepto.specJson = $(this).find(".goodsSpecListJson").text();
            $("#f_mask_" + itemId).show();
        	 $("#f_mask_" + itemId).find("#choose_color_size").css("height","100%");
        	//a(".f_mask").show();
        	
        },
        initProdNum: function() {
            var b = this,
            c = a(b),
            e = parseInt(c.val()),
            d = a(window).height();
            a(b).closest(".block");
            
            var g = a(b).closest(".block").find("div.promotion_title"),
            k = a(b).closest("div.cart_item").attr("id");
            pid = a(b).closest("div.cart_item").attr("item_id");
            a(".total_result").css({
                display: "none"
            });
            
            var h = f.scroller.y;
            setTimeout(function() {
                a(".maskup").css({
                    display: "block"
                });
                a(".total_result").height();
                window.isAndroidWebview && (f.refreshHeight(), (0 < a(b).offset().top ? a(b).offset().top: a(b).offset().top + a(window).height()) > d / 2 && (window.inputMoved = !0, f.scroller.scrollTo(0, h - 180), f.scroller && (f.scroller.destroy(), f.scroller = null)))
            },
            300);
            document.getElementsByTagName("body")[0].style.height = document.documentElement.clientHeight + "px";
            a(b).one("blur",
            function(d) {
                function n() {
                    if (/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent)) return ! 1;
                    if (/Chrome/i.test(navigator.userAgent)) return /Android/i.test(navigator.userAgent);
                    if (/Silk/i.test(navigator.userAgent)) return ! 1;
                    if (/Android/i.test(navigator.userAgent)) {
                        var a = navigator.userAgent.substr(navigator.userAgent.indexOf("Android") + 8, 3);
                        return 44 > parseFloat(a[0] + a[3]) ? !1 : !0
                    }
                }
                a(".total_result").css({
                    display: "block"
                });
                window.isAndroidWebview ? f.refreshHeight() : (f.scroller.scrollTo(0, f.scroller.y - a("#wrapper").scrollTop()), a("#wrapper").scrollTop(0), setTimeout(function() {
                    a(".maskup").css({
                        display: "none"
                    })
                },
                300));
                a(".maskup").css({
                    display: "none"
                });
                setTimeout(function() {
                    window.isAndroidWebview && window.inputMoved && (f.scroller = new IScroll("#wrapper", {
                        click: n()
                    }), f.refreshHeight(), window.inputMoved = !1, f.scroller.scrollTo(0, h));
                    a(".maskup").css({
                        display: "none"
                    })
                },
                300);
                var l = parseInt(a(b).val());
                if (isNaN(l) || 0 > l) return c.val(e),
                !1;
                if (0 === l) f.deleteItem(a(b),
                function() {
                    c.val(e)
                });
                else if (l != e) {
                    d = {};
                    var m = "";
                    g[0] && (m = g.attr("batch_id"));
                    d.batch_ids = m ? m + "." + l: "";
                    d.item_ids = m ? "": pid + "." + l;
                    a.ajaxOpt("update_number", d,
                    function(d) {
                        f.refreshHeight();
                        a("input[type=checkbox]", a(b).closest("div.cart_item")).prop("checked", !0);
                        f.autoCheckbox();
                        c.val(l);
                        f.getCartPriceAndQuantity();
                        gifts[k].maiazengb.products && a(b).closest("div.cart_item").find(".prd_tit span").html("x" + l)
                    },
                    "",
                    function() {
                        c.val(e);
                        a("input[type=checkbox]", a(b).closest("div.cart_item")).prop("checked", !0);
                        f.autoCheckbox();
                        f.getCartPriceAndQuantity()
                    })
                }
            });
            a("body").click(function(c) {
                a(c.target).hasClass("prod_num") || a(b).blur()
            });
            //重新计算商品总价格
            f.getTotalPrice();
        },
        closeBox: function() {
        	var v = "";
        	var data=[];
        	a(".color_options span").siblings().each(function(index){
        		//console.log(this)	
        	});
        	//a(".f_mask").hide();
        	//a("#choose_color_size").css("height","0");
        },
        //高度重新调整
        refreshHeight: function() {
            var b = window.innerHeight - a(".t-nav").height() - a("footer").height() - a(".h_label").height();
            a("#wrapper").height(b);
            f.scroller && f.scroller.refresh()
        },
        //商品总价格计算
        getTotalPrice: function(){   
        	var amt = 0;
        	var itemsum = 0;
        	$(".cart_item").each(function(){
        		var item = $(this).find("input");            	
            	if(item.prop("checked")){
            		var price = $(this).find(".cart_price").text();
            		var qty = $(this).find(".prod_num").val();            		
            		amt += Number(price) * Number(qty);  
            		itemsum ++;
            	}        		      		
        	});        	
        	
        	$("#cart_price").text(getRound(amt));
        	$("#cart_quantity").text(itemsum);
      
        	/*alert("11");
        	//获取勾选商品
        	var pro_items = a(".cart_item input[type=checkbox]");
        	if(pro_items.size()>0){
        		var totalPrice=0;
        		pro_items.each(function(){
	        		if(a(this).prop("checked")){
	        			var obj = a(this).closest(".cart_item")
	        			var price = obj.find(".cart_price").html().replace(/ /g,"").substring(1);
	        			var num = obj.find("input[type=number]").val();
	        			totalPrice+=price*num;
	        		}
	        	});
	        	totalPrice = totalPrice.toFixed(2);
	        	a("#cart_price span").html(totalPrice);
        	}else{
        		a("#cart_price span").html("0.00");
        	}*/
        },
        bindCheckout: function() {
        	var o = this;
            a("#do_checkout").click(function() {
            	var i=0;
                if (0 == hasChecked) return ! 1;
                //结算处理
                var cartData = [];
                
                $(".cart_item").each(function(){
                	var item = $(this).find("input[type='checkbox']");
                	if(item.prop("checked")){
                		i++;
                		var shopId = $(this).find("#shop_id").val();
                		var cartId = $(this).find(".cart_item").attr("item_id");
                		var imgPath = $(this).find(".pro_pic")[0].src;
                		var cart_price = $(this).find(".cart_price").text();
                		var goodsId = $(this).find(".goodsId").val();
                		var goodName = $(this).find(".prd_tit").find("a").text();
                		var qty = $(this).find(".prod_num").val();
                		var spec_st = $(this).find(".spec_st").text();
                		var specId = $(this).find(".specId").val();
                		var amt=0;
                		amt= Number(cart_price) * parseInt(qty);
                		var data = {
                			shopId:shopId,
                			cartId:cartId,
                			imgPath:imgPath,
                			price:cart_price,
                			goodsId:goodsId,
                			goodName:goodName,                			
                			qty:qty,
                			amt:amt,
                			spec:spec_st,
                			specId:specId
                		};
                		cartData.push(data)
                	}
                });
                
                if(i==0){
                	showError("购物车为空!请选择要买的商品");
                	return ;
                } 
                
                $.cookie('cartData', JSON.stringify(cartData),{ path: '/'}); 
                $("#cartData_ipt").val(JSON.stringify(cartData));
                $("#cart_form").submit();
                $(this).unbind('click');
            })
        },
        
        maskClick: function() {
            a(".maskup").css({
                display: "none"
            })
        }
    };
    //页面自适应
    a(window).resize(function(b) {
        f.empty || (b = window.innerHeight - a("footer").height() - a(".h_label").height(), a("#wrapper").height(b), document.getElementsByTagName("body")[0].style.height = document.documentElement.clientHeight + "px");
        f.scroller && f.scroller.refresh()
    });
    a(document).ready(function() {
        f.init();
        if (document.documentElement.scrollHeight <= document.documentElement.clientHeight) {
            window.hideurlbar = !0;
            var b = document.getElementsByTagName("body")[0];
            b.style.height = document.documentElement.clientWidth / screen.width * screen.height + "px"
        }
        window.hideurlbar && setTimeout(function() {
            window.scrollTo(0, 1);
            var c = b.style.height.replace("px", "") - a("footer").height() - a(".h_label").height();
            f.scroller && f.scroller.refresh(); ! f.empty && a("#wrapper").height(c)
        },
        0)
    })
})(Zepto);